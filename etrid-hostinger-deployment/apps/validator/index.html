<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ã‹TRID Validator Dashboard | Monitor Your Node</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Polkadot.js API -->
    <script src="https://cdn.jsdelivr.net/npm/@polkadot/api@10.9.1/bundle-polkadot-api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@polkadot/extension-dapp@0.46.5/bundle-polkadot-extension-dapp.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'etrid-blue': '#3B82F6',
                        'etrid-purple': '#8B5CF6',
                        'etrid-dark': '#0A0E1A',
                        'etrid-darker': '#050812',
                    },
                    fontFamily: { 'sans': ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 text-gray-900">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-etrid-blue to-etrid-purple flex items-center justify-center text-white text-xl font-bold">
                        V
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Validator Dashboard</h1>
                        <p class="text-xs text-gray-500">FlareChain Monitor</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <div id="connectionStatus" class="w-2 h-2 bg-red-500 rounded-full"></div>
                        <span id="connectionText" class="text-sm text-gray-600">Disconnected</span>
                    </div>
                    <button id="connectWalletBtn" class="px-4 py-2 bg-etrid-blue text-white rounded-lg hover:bg-etrid-blue/90 transition-colors font-medium text-sm">
                        Connect Wallet
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">

        <!-- Not Connected State -->
        <div id="notConnectedState" class="text-center py-20">
            <div class="max-w-md mx-auto">
                <div class="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-to-br from-etrid-blue to-etrid-purple flex items-center justify-center text-4xl text-white">
                    ðŸŽ¯
                </div>
                <h2 class="text-3xl font-bold mb-4">Connect Your Validator</h2>
                <p class="text-gray-600 mb-8">
                    Connect your wallet to monitor your validator performance and manage your node.
                </p>
                <button onclick="connectWallet()" class="bg-gradient-to-r from-etrid-blue to-etrid-purple px-8 py-4 rounded-xl font-bold text-lg text-white hover:shadow-lg transition-all">
                    Connect Polkadot.js Extension
                </button>
                <div class="mt-8 text-sm text-gray-500">
                    Don't have the extension? <a href="https://polkadot.js.org/extension/" target="_blank" class="text-etrid-blue hover:underline">Download here</a>
                </div>
            </div>
        </div>

        <!-- Connected State -->
        <div id="connectedState" class="hidden">

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm text-gray-600">Validator Status</h3>
                        <span id="validatorStatusBadge" class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded-full font-semibold">Active</span>
                    </div>
                    <p class="text-3xl font-bold text-gray-900" id="validatorStatus">Online</p>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-sm text-gray-600 mb-2">Total Stake</h3>
                    <p class="text-3xl font-bold text-gray-900" id="totalStake">0 Ã‰TR</p>
                    <p class="text-xs text-gray-500 mt-1" id="stakeUsd">$0 USD</p>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-sm text-gray-600 mb-2">Era Points</h3>
                    <p class="text-3xl font-bold text-gray-900" id="eraPoints">0</p>
                    <p class="text-xs text-green-600 mt-1">â†‘ Active Era</p>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-sm text-gray-600 mb-2">Commission</h3>
                    <p class="text-3xl font-bold text-gray-900" id="commission">0%</p>
                    <p class="text-xs text-gray-500 mt-1">Current rate</p>
                </div>
            </div>

            <!-- Performance Chart -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h3 class="text-lg font-semibold mb-4">Performance (Last 30 Days)</h3>
                <canvas id="performanceChart" height="80"></canvas>
            </div>

            <!-- Two Column Layout -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <!-- Left Column (2/3) -->
                <div class="lg:col-span-2 space-y-6">

                    <!-- Validator Info -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold mb-4">Validator Information</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between py-3 border-b">
                                <span class="text-gray-600">Validator Address</span>
                                <code id="validatorAddress" class="text-sm text-etrid-blue font-mono">-</code>
                            </div>
                            <div class="flex justify-between py-3 border-b">
                                <span class="text-gray-600">Controller Address</span>
                                <code id="controllerAddress" class="text-sm text-gray-900 font-mono">-</code>
                            </div>
                            <div class="flex justify-between py-3 border-b">
                                <span class="text-gray-600">Session Keys</span>
                                <span class="text-sm text-green-600 font-semibold">âœ“ Set</span>
                            </div>
                            <div class="flex justify-between py-3 border-b">
                                <span class="text-gray-600">Identity</span>
                                <span id="validatorIdentity" class="text-sm text-gray-900">-</span>
                            </div>
                            <div class="flex justify-between py-3">
                                <span class="text-gray-600">Nominators</span>
                                <span id="nominatorsCount" class="text-sm font-semibold text-gray-900">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Blocks -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold mb-4">Recent Blocks Produced</h3>
                        <div id="recentBlocks" class="space-y-3">
                            <div class="text-center py-8 text-gray-400">
                                No recent blocks data available
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Right Column (1/3) -->
                <div class="space-y-6">

                    <!-- Quick Stats -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold mb-4">Quick Stats</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between pb-3 border-b">
                                <span class="text-sm text-gray-600">Uptime</span>
                                <span class="text-sm font-semibold text-gray-900">99.8%</span>
                            </div>
                            <div class="flex justify-between pb-3 border-b">
                                <span class="text-sm text-gray-600">Rank</span>
                                <span class="text-sm font-semibold text-gray-900">#<span id="validatorRank">-</span></span>
                            </div>
                            <div class="flex justify-between pb-3 border-b">
                                <span class="text-sm text-gray-600">Blocks Produced</span>
                                <span class="text-sm font-semibold text-gray-900" id="blocksProduced">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Missed Blocks</span>
                                <span class="text-sm font-semibold text-red-600" id="missedBlocks">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Rewards -->
                    <div class="bg-gradient-to-br from-etrid-blue/10 to-etrid-purple/10 border border-etrid-blue/20 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">Rewards</h3>
                        <div class="space-y-3">
                            <div>
                                <p class="text-xs text-gray-600 mb-1">Current Era</p>
                                <p class="text-2xl font-bold text-gray-900" id="currentEraRewards">0 Ã‰TR</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 mb-1">Total Earned</p>
                                <p class="text-lg font-semibold text-gray-900" id="totalRewards">0 Ã‰TR</p>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold mb-4">Actions</h3>
                        <div class="space-y-3">
                            <button class="w-full px-4 py-3 bg-etrid-blue text-white rounded-lg hover:bg-etrid-blue/90 transition-colors font-medium text-sm">
                                Update Commission
                            </button>
                            <button class="w-full px-4 py-3 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium text-sm">
                                Set Identity
                            </button>
                            <button class="w-full px-4 py-3 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium text-sm">
                                Rotate Session Keys
                            </button>
                        </div>
                    </div>

                </div>

            </div>

        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-white border-t mt-12 py-6">
        <div class="max-w-7xl mx-auto px-4 text-center text-gray-600 text-sm">
            <p>&copy; 2025 Ã‹TRID Protocol. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // State
        let api = null;
        let currentAccount = null;
        let performanceChart = null;
        const RPC_ENDPOINT = 'ws://98.71.91.84:9944';
        const ETR_PRICE_USD = 8.0;

        // Connect to blockchain
        async function connectToBlockchain() {
            try {
                console.log('Connecting to FlareChain...');
                const { ApiPromise, WsProvider } = window.polkadotApi;
                const provider = new WsProvider(RPC_ENDPOINT);

                api = await ApiPromise.create({ provider });

                console.log('âœ… Connected to FlareChain');
                updateConnectionStatus(true);

            } catch (error) {
                console.error('Failed to connect to blockchain:', error);
                updateConnectionStatus(false);
            }
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const statusDot = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');

            if (connected) {
                statusDot.className = 'w-2 h-2 bg-green-500 rounded-full';
                statusText.textContent = 'Connected';
                statusText.className = 'text-sm text-green-600';
            } else {
                statusDot.className = 'w-2 h-2 bg-red-500 rounded-full';
                statusText.textContent = 'Disconnected';
                statusText.className = 'text-sm text-red-600';
            }
        }

        // Connect wallet
        async function connectWallet() {
            try {
                if (!window.polkadotExtensionDapp) {
                    alert('Please install Polkadot.js Extension!\n\nDownload: https://polkadot.js.org/extension/');
                    return;
                }

                const { web3Accounts, web3Enable } = window.polkadotExtensionDapp;
                const extensions = await web3Enable('Ã‹TRID Validator Dashboard');

                if (extensions.length === 0) {
                    alert('Please install Polkadot.js Extension!\n\nDownload: https://polkadot.js.org/extension/');
                    return;
                }

                const accounts = await web3Accounts();
                if (accounts.length === 0) {
                    alert('No accounts found. Please create an account in Polkadot.js Extension.');
                    return;
                }

                currentAccount = accounts[0];

                // Update UI
                document.getElementById('notConnectedState').classList.add('hidden');
                document.getElementById('connectedState').classList.remove('hidden');

                const shortAddress = `${currentAccount.address.slice(0, 6)}...${currentAccount.address.slice(-4)}`;
                document.getElementById('connectWalletBtn').textContent = shortAddress;
                document.getElementById('connectWalletBtn').classList.add('bg-green-600');
                document.getElementById('connectWalletBtn').classList.remove('bg-etrid-blue');

                document.getElementById('validatorAddress').textContent = currentAccount.address;
                document.getElementById('controllerAddress').textContent = currentAccount.address;

                await loadValidatorData();
                initPerformanceChart();

            } catch (error) {
                console.error('Failed to connect wallet:', error);
                alert('Failed to connect wallet. Please try again.');
            }
        }

        // Load validator data
        async function loadValidatorData() {
            if (!api || !currentAccount) return;

            try {
                // Get account balance
                const { data: balance } = await api.query.system.account(currentAccount.address);
                const totalBalance = (balance.free.toString() / 1e18).toFixed(2);

                document.getElementById('totalStake').textContent = `${totalBalance} Ã‰TR`;
                document.getElementById('stakeUsd').textContent = `$${(parseFloat(totalBalance) * ETR_PRICE_USD).toFixed(2)} USD`;

                // Get current block
                const chain = await api.rpc.chain.getHeader();
                const blockNumber = chain.number.toNumber();

                // Simulate validator data (would come from chain in production)
                document.getElementById('eraPoints').textContent = Math.floor(Math.random() * 500 + 100);
                document.getElementById('commission').textContent = '5%';
                document.getElementById('nominatorsCount').textContent = Math.floor(Math.random() * 50 + 10);
                document.getElementById('blocksProduced').textContent = Math.floor(blockNumber / 100);
                document.getElementById('missedBlocks').textContent = Math.floor(Math.random() * 5);
                document.getElementById('validatorRank').textContent = Math.floor(Math.random() * 21 + 1);
                document.getElementById('currentEraRewards').textContent = (Math.random() * 50 + 10).toFixed(2) + ' Ã‰TR';
                document.getElementById('totalRewards').textContent = (Math.random() * 500 + 100).toFixed(2) + ' Ã‰TR';

            } catch (error) {
                console.error('Failed to load validator data:', error);
            }
        }

        // Initialize performance chart
        function initPerformanceChart() {
            const ctx = document.getElementById('performanceChart');
            if (!ctx) return;

            // Generate sample data
            const labels = [];
            const data = [];
            for (let i = 30; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                data.push(Math.floor(Math.random() * 20) + 80); // 80-100 range
            }

            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Uptime %',
                        data: data,
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 70,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ðŸš€ Validator Dashboard Initializing...');
            await connectToBlockchain();

            document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);

            // Auto-refresh every 30 seconds
            setInterval(() => {
                if (currentAccount) {
                    loadValidatorData();
                }
            }, 30000);
        });
    </script>

</body>
</html>
