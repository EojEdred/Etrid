<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Network Dashboard - Etrid Operations Center</title>
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    .tabs-container {
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
      margin: 20px 0;
    }

    .tabs-header {
      display: flex;
      background: var(--background-color);
      border-bottom: 2px solid var(--border-color);
      overflow-x: auto;
    }

    .tab-button {
      flex: 1;
      min-width: 150px;
      padding: 16px 24px;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: relative;
    }

    .tab-button:hover {
      background: rgba(77, 163, 255, 0.05);
      color: var(--text-primary);
    }

    .tab-button.active {
      color: var(--accent-blue);
      background: var(--surface-color);
    }

    .tab-button.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
    }

    .tab-badge {
      padding: 2px 8px;
      border-radius: 10px;
      background: var(--accent-red);
      color: white;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .tab-content {
      padding: 24px;
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .metric-card {
      background: var(--background-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }

    .metric-card .icon {
      font-size: 2rem;
      margin-bottom: 8px;
    }

    .metric-card .value {
      font-size: 2rem;
      font-weight: 700;
      margin: 8px 0;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .metric-card .label {
      color: var(--text-secondary);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metric-card .live-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
      font-size: 0.8rem;
      color: var(--accent-green);
    }

    .pulse-dot {
      width: 8px;
      height: 8px;
      background: var(--accent-green);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    #map {
      height: 600px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .map-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .map-button {
      padding: 8px 16px;
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .map-button:hover {
      background: rgba(77, 163, 255, 0.1);
      border-color: var(--accent-blue);
    }

    .map-button.active {
      background: var(--accent-blue);
      color: white;
      border-color: var(--accent-blue);
    }

    .chart-container {
      background: var(--background-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      height: 350px;
      position: relative;
    }

    .validators-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }

    .validators-table th,
    .validators-table td {
      padding: 14px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .validators-table th {
      background: var(--background-color);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
    }

    .validators-table tr:hover {
      background: rgba(77, 163, 255, 0.05);
      cursor: pointer;
    }

    .alert-item {
      background: var(--background-color);
      border-left: 4px solid var(--accent-yellow);
      border-radius: 8px;
      padding: 16px;
      margin: 12px 0;
      display: flex;
      align-items: start;
      gap: 16px;
    }

    .alert-item.high {
      border-left-color: var(--accent-red);
    }

    .alert-item.medium {
      border-left-color: var(--accent-yellow);
    }

    .alert-item.low {
      border-left-color: var(--accent-blue);
    }

    .alert-icon {
      font-size: 2rem;
    }

    .alert-content {
      flex: 1;
    }

    .alert-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .severity-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .severity-badge.high {
      background: rgba(255, 82, 82, 0.15);
      color: var(--accent-red);
    }

    .severity-badge.medium {
      background: rgba(255, 184, 0, 0.15);
      color: var(--accent-yellow);
    }

    .alert-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .alert-btn {
      padding: 6px 14px;
      background: var(--accent-blue);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: opacity 0.2s;
    }

    .alert-btn:hover {
      opacity: 0.9;
    }

    .alert-btn.secondary {
      background: var(--surface-color);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .webhook-config {
      background: var(--background-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    .webhook-input {
      width: 100%;
      padding: 12px;
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin: 8px 0;
      font-size: 0.95rem;
      color: var(--text-primary);
    }

    .webhook-test {
      padding: 10px 20px;
      background: var(--accent-green);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: opacity 0.2s;
    }

    .webhook-test:hover {
      opacity: 0.9;
    }

    .export-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }

    .export-card {
      background: var(--background-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .export-card .icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }

    .export-card h4 {
      margin: 12px 0;
    }

    .export-card p {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 16px;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.85rem;
    }

    .connection-status.connected {
      border-color: var(--accent-green);
      color: var(--accent-green);
    }

    .connection-status.disconnected {
      border-color: var(--accent-red);
      color: var(--accent-red);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div>
        <h1 style="display: flex; align-items: center; gap: 16px;">
          üåê Network Dashboard
          <span id="network-status-badge" class="status-badge">Loading...</span>
        </h1>
        <p class="subtitle">Unified monitoring platform for Etrid network</p>
      </div>
      <div style="display: flex; gap: 12px; align-items: center;">
        <div id="connection-status" class="connection-status disconnected">
          <span class="pulse-dot"></span>
          <span>Connecting...</span>
        </div>
        <button class="btn btn-secondary" onclick="window.location.href='/dashboard.html'">
          ‚Üê Dashboard
        </button>
        <button class="btn btn-secondary" onclick="handleLogout()">Logout</button>
      </div>
    </div>

    <!-- Tabbed Interface -->
    <div class="tabs-container">
      <div class="tabs-header">
        <button class="tab-button active" onclick="switchTab('overview')">
          <span>üìä</span> Overview
        </button>
        <button class="tab-button" onclick="switchTab('map')">
          <span>üó∫Ô∏è</span> Geographic Map
        </button>
        <button class="tab-button" onclick="switchTab('finality')">
          <span>‚ö°</span> Finality Metrics
        </button>
        <button class="tab-button" onclick="switchTab('alerts')">
          <span>üîî</span> Alerts
          <span id="alerts-badge" class="tab-badge" style="display: none;">0</span>
        </button>
        <button class="tab-button" onclick="switchTab('export')">
          <span>üíæ</span> Export & Reports
        </button>
      </div>

      <!-- Overview Tab -->
      <div id="tab-overview" class="tab-content active">
        <h3>Network Overview</h3>
        <div class="metrics-grid">
          <div class="metric-card">
            <div class="icon">üîó</div>
            <div class="value" id="total-validators">-</div>
            <div class="label">Total Validators</div>
            <div class="live-indicator">
              <span class="pulse-dot"></span>
              <span>Live</span>
            </div>
          </div>
          <div class="metric-card">
            <div class="icon">üü¢</div>
            <div class="value" id="online-validators">-</div>
            <div class="label">Online Now</div>
          </div>
          <div class="metric-card">
            <div class="icon">üìä</div>
            <div class="value" id="network-block-height">-</div>
            <div class="label">Block Height</div>
          </div>
          <div class="metric-card">
            <div class="icon">üåç</div>
            <div class="value" id="total-peers">-</div>
            <div class="label">Total Peers</div>
          </div>
          <div class="metric-card">
            <div class="icon">‚ö°</div>
            <div class="value" id="avg-finality">-</div>
            <div class="label">Finality Time</div>
          </div>
          <div class="metric-card">
            <div class="icon">‚è±Ô∏è</div>
            <div class="value" id="avg-block-time">-</div>
            <div class="label">Block Time</div>
          </div>
        </div>

        <h3 style="margin-top: 40px;">All Validators</h3>
        <div style="overflow-x: auto;">
          <table class="validators-table">
            <thead>
              <tr>
                <th>Status</th>
                <th>Name</th>
                <th>Location</th>
                <th>Block Height</th>
                <th>Peers</th>
                <th>Version</th>
                <th>Last Update</th>
              </tr>
            </thead>
            <tbody id="validators-tbody">
              <tr>
                <td colspan="7" style="text-align: center; padding: 40px;">Loading validators...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Map Tab -->
      <div id="tab-map" class="tab-content">
        <h3>Geographic Distribution</h3>
        <p style="color: var(--text-secondary); margin-bottom: 16px;">
          Real-time visualization of all 21 Etrid validators across datacenters
        </p>
        <div class="map-controls">
          <button class="map-button active" onclick="setMapView('world')">üåç World View</button>
          <button class="map-button" onclick="setMapView('americas')">üåé Americas</button>
          <button class="map-button" onclick="setMapView('europe')">üåç Europe</button>
          <button class="map-button" onclick="setMapView('asia')">üåè Asia</button>
          <button class="map-button" onclick="toggleHeatmap()">üî• Toggle Heatmap</button>
        </div>
        <div id="map"></div>
        <div style="margin-top: 16px; padding: 16px; background: var(--background-color); border-radius: 8px;">
          <strong>Legend:</strong>
          <span style="margin-left: 20px;">üü¢ Online</span>
          <span style="margin-left: 20px;">üî¥ Offline</span>
          <span style="margin-left: 20px;">üü° Syncing</span>
        </div>
      </div>

      <!-- Finality Tab -->
      <div id="tab-finality" class="tab-content">
        <h3>ASF Finality Metrics</h3>

        <div class="metrics-grid">
          <div class="metric-card">
            <div class="icon">‚ö°</div>
            <div class="value" id="current-finality">-</div>
            <div class="label">Current Finality</div>
            <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 8px;">Target: &lt; 20s</div>
          </div>
          <div class="metric-card">
            <div class="icon">‚è±Ô∏è</div>
            <div class="value" id="current-blocktime">-</div>
            <div class="label">Block Time</div>
            <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 8px;">Target: ~5s</div>
          </div>
          <div class="metric-card">
            <div class="icon">üìä</div>
            <div class="value" id="current-tps">-</div>
            <div class="label">Network TPS</div>
          </div>
          <div class="metric-card">
            <div class="icon">üîó</div>
            <div class="value" id="block-lag">-</div>
            <div class="label">Block Lag</div>
          </div>
        </div>

        <h4 style="margin-top: 30px;">Finality Time History (24H)</h4>
        <div class="chart-container">
          <canvas id="finality-chart"></canvas>
        </div>

        <h4 style="margin-top: 30px;">Block Time History (24H)</h4>
        <div class="chart-container">
          <canvas id="blocktime-chart"></canvas>
        </div>
      </div>

      <!-- Alerts Tab -->
      <div id="tab-alerts" class="tab-content">
        <h3>Network Alerts & Notifications</h3>

        <div id="active-alerts">
          <h4>Active Alerts</h4>
          <div id="alerts-container">
            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
              No active alerts
            </div>
          </div>
        </div>

        <div class="webhook-config" style="margin-top: 40px;">
          <h4>‚öôÔ∏è Webhook Configuration</h4>
          <p style="color: var(--text-secondary); margin-bottom: 16px;">
            Configure Telegram or Discord webhooks to receive real-time alerts
          </p>

          <label style="display: block; margin-top: 20px; font-weight: 600;">
            Telegram Bot Token
          </label>
          <input
            type="text"
            class="webhook-input"
            id="telegram-token"
            placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz"
          />

          <label style="display: block; margin-top: 20px; font-weight: 600;">
            Telegram Chat ID
          </label>
          <input
            type="text"
            class="webhook-input"
            id="telegram-chat"
            placeholder="-1001234567890"
          />

          <label style="display: block; margin-top: 20px; font-weight: 600;">
            Discord Webhook URL
          </label>
          <input
            type="text"
            class="webhook-input"
            id="discord-webhook"
            placeholder="https://discord.com/api/webhooks/..."
          />

          <div style="margin-top: 20px; display: flex; gap: 12px;">
            <button class="webhook-test" onclick="saveWebhookConfig()">
              üíæ Save Configuration
            </button>
            <button class="webhook-test" style="background: var(--accent-blue);" onclick="testWebhook()">
              üß™ Send Test Alert
            </button>
          </div>
        </div>

        <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, rgba(77, 163, 255, 0.1), rgba(0, 214, 143, 0.1)); border-radius: 12px;">
          <h4>üí° Alert Conditions</h4>
          <ul style="margin: 12px 0; padding-left: 24px;">
            <li>Validator goes offline (High severity)</li>
            <li>Finality time exceeds 20 seconds (Medium severity)</li>
            <li>Block height sync issues (Medium severity)</li>
            <li>Low peer count (&lt; 5 peers) (Low severity)</li>
            <li>Version fragmentation detected (Low severity)</li>
          </ul>
        </div>
      </div>

      <!-- Export Tab -->
      <div id="tab-export" class="tab-content">
        <h3>Export & Reports</h3>
        <p style="color: var(--text-secondary); margin-bottom: 24px;">
          Generate comprehensive reports of network activity and metrics
        </p>

        <div class="export-section">
          <div class="export-card">
            <div class="icon">üìä</div>
            <h4>CSV Export</h4>
            <p>Export current validator data as CSV for spreadsheet analysis</p>
            <button class="btn btn-primary" onclick="exportCSV()">
              Download CSV
            </button>
          </div>

          <div class="export-card">
            <div class="icon">üìÑ</div>
            <h4>PDF Report</h4>
            <p>Generate a comprehensive PDF report with charts and metrics</p>
            <button class="btn btn-primary" onclick="exportPDF()">
              Generate PDF
            </button>
          </div>

          <div class="export-card">
            <div class="icon">üìà</div>
            <h4>Historical Data</h4>
            <p>Export historical finality and network metrics (JSON)</p>
            <button class="btn btn-primary" onclick="exportHistorical()">
              Download JSON
            </button>
          </div>

          <div class="export-card">
            <div class="icon">üìß</div>
            <h4>Email Report</h4>
            <p>Schedule daily/weekly reports via email</p>
            <button class="btn btn-secondary" onclick="showToast('Coming soon!', 'info')">
              Configure
            </button>
          </div>
        </div>

        <div style="margin-top: 30px; padding: 20px; background: var(--background-color); border: 1px solid var(--border-color); border-radius: 12px;">
          <h4>üìÖ Report Schedule</h4>
          <p style="color: var(--text-secondary); margin: 12px 0;">
            Automatically generate and send reports on a schedule
          </p>
          <div style="display: flex; gap: 12px; margin-top: 16px;">
            <button class="btn btn-secondary">Daily Summary</button>
            <button class="btn btn-secondary">Weekly Report</button>
            <button class="btn btn-secondary">Monthly Overview</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/auth.js"></script>
  <script>
    let socket = null;
    let map = null;
    let markers = {};
    let finalityChart = null;
    let blocktimeChart = null;
    let allValidators = [];
    let activeAlerts = [];

    // Initialize WebSocket connection
    function initWebSocket() {
      const token = localStorage.getItem('token');
      socket = io({
        auth: { token }
      });

      socket.on('connect', () => {
        console.log('WebSocket connected');
        updateConnectionStatus(true);
      });

      socket.on('disconnect', () => {
        console.log('WebSocket disconnected');
        updateConnectionStatus(false);
      });

      socket.on('network-update', (data) => {
        console.log('Network update received:', data);
        updateNetworkData(data);
      });

      socket.on('finality-update', (data) => {
        console.log('Finality update received:', data);
        updateFinalityData(data);
      });

      socket.on('alert', (alert) => {
        console.log('Alert received:', alert);
        handleNewAlert(alert);
      });
    }

    function updateConnectionStatus(connected) {
      const status = document.getElementById('connection-status');
      if (connected) {
        status.className = 'connection-status connected';
        status.innerHTML = '<span class="pulse-dot"></span><span>Live</span>';
      } else {
        status.className = 'connection-status disconnected';
        status.innerHTML = '<span class="pulse-dot" style="background: var(--accent-red);"></span><span>Disconnected</span>';
      }
    }

    // Tab switching
    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.closest('.tab-button').classList.add('active');

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`tab-${tabName}`).classList.add('active');

      // Initialize map if switching to map tab
      if (tabName === 'map' && !map) {
        initMap();
      }
    }

    // Initialize Leaflet map
    function initMap() {
      map = L.map('map').setView([20, 0], 2);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 18
      }).addTo(map);

      // Add validators to map
      updateMapMarkers();
    }

    function updateMapMarkers() {
      if (!map) return;

      // Clear existing markers
      Object.values(markers).forEach(marker => marker.remove());
      markers = {};

      // Datacenter locations (common cloud provider locations)
      const locations = {
        'us-east': [39.0, -77.5],
        'us-west': [37.4, -122.1],
        'eu-west': [53.3, -6.3],
        'eu-central': [50.1, 8.7],
        'asia-pacific': [1.3, 103.8],
        'asia-northeast': [35.7, 139.7]
      };

      allValidators.forEach((validator, index) => {
        const locationKey = validator.location || Object.keys(locations)[index % Object.keys(locations).length];
        const coords = locations[locationKey] || locations['us-east'];

        // Add some randomness to avoid exact overlaps
        const lat = coords[0] + (Math.random() - 0.5) * 2;
        const lng = coords[1] + (Math.random() - 0.5) * 2;

        const color = validator.status === 'online' ? 'green' : validator.isSyncing ? 'orange' : 'red';
        const icon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="background: ${color}; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>`,
          iconSize: [16, 16]
        });

        const marker = L.marker([lat, lng], { icon }).addTo(map);
        marker.bindPopup(`
          <strong>${validator.nodeName}</strong><br/>
          Status: ${validator.status}<br/>
          Block: ${validator.blockHeight?.toLocaleString() || '-'}<br/>
          Peers: ${validator.peers || '-'}<br/>
          Version: ${validator.version || '-'}
        `);

        markers[validator.id] = marker;
      });
    }

    function setMapView(region) {
      if (!map) return;

      const views = {
        'world': [[20, 0], 2],
        'americas': [[40, -100], 3],
        'europe': [[50, 10], 4],
        'asia': [[30, 100], 3]
      };

      const [center, zoom] = views[region] || views['world'];
      map.setView(center, zoom);

      // Update active button
      document.querySelectorAll('.map-button').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
    }

    function toggleHeatmap() {
      showToast('Heatmap feature coming soon!', 'info');
    }

    // Load network data
    async function loadNetworkData() {
      try {
        const response = await authenticatedFetch('/api/network/overview');
        const data = await response.json();

        allValidators = data.validators;
        updateNetworkData(data);
      } catch (err) {
        console.error('Failed to load network data:', err);
        showError('Failed to load network data');
      }
    }

    function updateNetworkData(data) {
      // Update metrics
      const stats = data.stats || {};
      document.getElementById('total-validators').textContent = stats.totalValidators || '-';
      document.getElementById('online-validators').textContent = stats.onlineValidators || '-';
      document.getElementById('network-block-height').textContent = (stats.averageBlockHeight || 0).toLocaleString();
      document.getElementById('total-peers').textContent = stats.totalPeers || '-';

      if (data.finality) {
        document.getElementById('avg-finality').textContent = `${data.finality.finalityTime.toFixed(1)}s`;
        document.getElementById('avg-block-time').textContent = `${data.finality.blockTime.toFixed(1)}s`;
      }

      // Update validators table
      if (data.validators) {
        updateValidatorsTable(data.validators);
        if (map) updateMapMarkers();
      }

      // Update network status badge
      const badge = document.getElementById('network-status-badge');
      if (stats.onlineValidators === stats.totalValidators) {
        badge.textContent = '‚úì All Online';
        badge.className = 'status-badge online';
      } else {
        badge.textContent = '‚ö† Some Issues';
        badge.className = 'status-badge offline';
      }
    }

    function updateValidatorsTable(validators) {
      const tbody = document.getElementById('validators-tbody');

      if (validators.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No validators found</td></tr>';
        return;
      }

      tbody.innerHTML = validators.map(v => {
        const statusIcon = v.status === 'online' ? 'üü¢' : 'üî¥';
        const syncBadge = v.isSyncing ? ' <span style="color: var(--accent-yellow);">‚Üª</span>' : '';
        return `
          <tr onclick="viewValidator('${v.nodeName}')">
            <td>${statusIcon}${syncBadge}</td>
            <td><strong>${v.nodeName}</strong></td>
            <td>${v.location || 'Unknown'}</td>
            <td>${v.blockHeight ? v.blockHeight.toLocaleString() : '-'}</td>
            <td>${v.peers || '-'}</td>
            <td style="font-family: monospace; font-size: 0.9rem;">${v.version || '-'}</td>
            <td style="color: var(--text-secondary); font-size: 0.85rem;">
              ${v.lastUpdated ? new Date(v.lastUpdated).toLocaleTimeString() : '-'}
            </td>
          </tr>
        `;
      }).join('');
    }

    // Load finality data
    async function loadFinalityData() {
      try {
        const [metricsRes, historicalRes] = await Promise.all([
          authenticatedFetch('/api/finality/metrics'),
          authenticatedFetch('/api/finality/historical?hours=24')
        ]);

        const metrics = await metricsRes.json();
        const historical = await historicalRes.json();

        updateFinalityData(metrics);
        updateFinalityCharts(historical.data || []);
      } catch (err) {
        console.error('Failed to load finality data:', err);
      }
    }

    function updateFinalityData(metrics) {
      document.getElementById('current-finality').textContent = `${metrics.finalityTime.toFixed(1)}s`;
      document.getElementById('current-blocktime').textContent = `${metrics.blockTime.toFixed(1)}s`;
      document.getElementById('current-tps').textContent = metrics.networkTps.toFixed(0);
      document.getElementById('block-lag').textContent = (metrics.bestBlock - metrics.finalizedBlock).toLocaleString();
    }

    function updateFinalityCharts(data) {
      if (data.length === 0) {
        data = generateMockFinalityData();
      }

      const labels = data.map(d => new Date(d.timestamp).toLocaleTimeString());
      const finalityData = data.map(d => d.finalityTime);
      const blocktimeData = data.map(d => d.blockTime);

      // Finality chart
      const ctx1 = document.getElementById('finality-chart');
      if (ctx1) {
        if (finalityChart) finalityChart.destroy();
        finalityChart = new Chart(ctx1.getContext('2d'), {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Finality Time (s)',
              data: finalityData,
              borderColor: 'rgb(77, 163, 255)',
              backgroundColor: 'rgba(77, 163, 255, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true, title: { display: true, text: 'Seconds' } }
            }
          }
        });
      }

      // Block time chart
      const ctx2 = document.getElementById('blocktime-chart');
      if (ctx2) {
        if (blocktimeChart) blocktimeChart.destroy();
        blocktimeChart = new Chart(ctx2.getContext('2d'), {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Block Time (s)',
              data: blocktimeData,
              borderColor: 'rgb(0, 214, 143)',
              backgroundColor: 'rgba(0, 214, 143, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true, title: { display: true, text: 'Seconds' } }
            }
          }
        });
      }
    }

    function generateMockFinalityData() {
      const data = [];
      const now = Date.now();
      for (let i = 0; i < 48; i++) {
        data.push({
          timestamp: now - (1800000 * (48 - i)),
          finalityTime: 12 + Math.random() * 8,
          blockTime: 4.5 + Math.random() * 1.5
        });
      }
      return data;
    }

    // Check for alerts
    async function checkAlerts() {
      try {
        const response = await authenticatedFetch('/api/network/issues');
        const data = await response.json();

        if (data.issues && data.issues.length > 0) {
          activeAlerts = data.issues;
          updateAlertsUI();
        } else {
          activeAlerts = [];
          updateAlertsUI();
        }
      } catch (err) {
        console.error('Failed to check alerts:', err);
      }
    }

    function updateAlertsUI() {
      const container = document.getElementById('alerts-container');
      const badge = document.getElementById('alerts-badge');

      if (activeAlerts.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">No active alerts</div>';
        badge.style.display = 'none';
        return;
      }

      badge.style.display = 'inline-block';
      badge.textContent = activeAlerts.length;

      container.innerHTML = activeAlerts.map(alert => `
        <div class="alert-item ${alert.severity}">
          <div class="alert-icon">${alert.severity === 'high' ? 'üî¥' : alert.severity === 'medium' ? 'üü°' : 'üîµ'}</div>
          <div class="alert-content">
            <div class="alert-header">
              <span class="severity-badge ${alert.severity}">${alert.severity}</span>
              <strong>${alert.type.replace(/_/g, ' ').toUpperCase()}</strong>
            </div>
            <p style="margin: 8px 0; color: var(--text-secondary);">${alert.message}</p>
            ${alert.affectedValidators ? `
              <div style="font-size: 0.85rem; margin-top: 8px;">
                <strong>Affected:</strong> ${alert.affectedValidators.join(', ')}
              </div>
            ` : ''}
            <div class="alert-actions">
              <button class="alert-btn" onclick="acknowledgeAlert('${alert.type}')">Acknowledge</button>
              <button class="alert-btn secondary" onclick="viewAlertDetails('${alert.type}')">View Details</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function handleNewAlert(alert) {
      activeAlerts.push(alert);
      updateAlertsUI();
      showToast(`New ${alert.severity} alert: ${alert.message}`, 'error');
    }

    function acknowledgeAlert(type) {
      activeAlerts = activeAlerts.filter(a => a.type !== type);
      updateAlertsUI();
      showToast('Alert acknowledged', 'success');
    }

    function viewAlertDetails(type) {
      showToast('Alert details view coming soon!', 'info');
    }

    // Webhook functions
    async function saveWebhookConfig() {
      const config = {
        telegram: {
          token: document.getElementById('telegram-token').value,
          chatId: document.getElementById('telegram-chat').value
        },
        discord: {
          webhookUrl: document.getElementById('discord-webhook').value
        }
      };

      try {
        const response = await authenticatedFetch('/api/webhooks/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });

        if (response.ok) {
          showToast('Webhook configuration saved!', 'success');
        } else {
          showToast('Failed to save configuration', 'error');
        }
      } catch (err) {
        console.error('Failed to save webhook config:', err);
        showToast('Error saving configuration', 'error');
      }
    }

    async function testWebhook() {
      try {
        const response = await authenticatedFetch('/api/webhooks/test', {
          method: 'POST'
        });

        if (response.ok) {
          showToast('Test alert sent! Check your Telegram/Discord', 'success');
        } else {
          showToast('Failed to send test alert', 'error');
        }
      } catch (err) {
        console.error('Failed to send test webhook:', err);
        showToast('Error sending test alert', 'error');
      }
    }

    // Export functions
    function exportCSV() {
      const csv = ['Name,Status,Location,Block Height,Peers,Version,Chain'];

      allValidators.forEach(v => {
        csv.push([
          v.nodeName,
          v.status,
          v.location || 'Unknown',
          v.blockHeight || 0,
          v.peers || 0,
          v.version || 'Unknown',
          v.chain
        ].join(','));
      });

      downloadFile(csv.join('\n'), `etrid-validators-${Date.now()}.csv`, 'text/csv');
      showToast('CSV downloaded!', 'success');
    }

    async function exportPDF() {
      showToast('Generating PDF report...', 'info');

      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Title
        doc.setFontSize(20);
        doc.text('Etrid Network Report', 20, 20);

        // Date
        doc.setFontSize(12);
        doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 30);

        // Network Summary
        doc.setFontSize(16);
        doc.text('Network Summary', 20, 45);
        doc.setFontSize(12);
        doc.text(`Total Validators: ${document.getElementById('total-validators').textContent}`, 20, 55);
        doc.text(`Online Validators: ${document.getElementById('online-validators').textContent}`, 20, 65);
        doc.text(`Block Height: ${document.getElementById('network-block-height').textContent}`, 20, 75);
        doc.text(`Total Peers: ${document.getElementById('total-peers').textContent}`, 20, 85);
        doc.text(`Avg Finality: ${document.getElementById('avg-finality').textContent}`, 20, 95);

        // Validators list
        doc.setFontSize(16);
        doc.text('Validators', 20, 115);
        doc.setFontSize(10);

        let y = 125;
        allValidators.slice(0, 15).forEach((v, i) => {
          doc.text(`${i + 1}. ${v.nodeName} - ${v.status} (${v.blockHeight?.toLocaleString() || '-'} blocks)`, 20, y);
          y += 8;
        });

        doc.save(`etrid-report-${Date.now()}.pdf`);
        showToast('PDF report generated!', 'success');
      } catch (err) {
        console.error('Failed to generate PDF:', err);
        showToast('Failed to generate PDF', 'error');
      }
    }

    async function exportHistorical() {
      try {
        const response = await authenticatedFetch('/api/finality/historical?hours=168');
        const data = await response.json();

        downloadFile(
          JSON.stringify(data, null, 2),
          `etrid-historical-${Date.now()}.json`,
          'application/json'
        );
        showToast('Historical data downloaded!', 'success');
      } catch (err) {
        console.error('Failed to export historical data:', err);
        showToast('Failed to export data', 'error');
      }
    }

    function downloadFile(content, filename, type) {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      link.click();
      URL.revokeObjectURL(url);
    }

    // Utility functions
    function viewValidator(nodeName) {
      window.location.href = `/validator.html?node=${encodeURIComponent(nodeName)}`;
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function showError(message) {
      showToast(message, 'error');
    }

    function handleLogout() {
      logout();
      window.location.href = '/login.html';
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', async () => {
      await loadUserInfo();
      await loadNetworkData();
      await loadFinalityData();
      await checkAlerts();

      // Initialize WebSocket
      initWebSocket();

      // Auto-refresh every 30 seconds
      setInterval(async () => {
        await loadNetworkData();
        await checkAlerts();
      }, 30000);

      // Refresh finality every 15 seconds
      setInterval(loadFinalityData, 15000);
    });

    // Cleanup
    window.addEventListener('beforeunload', () => {
      if (socket) socket.disconnect();
      if (finalityChart) finalityChart.destroy();
      if (blocktimeChart) blocktimeChart.destroy();
    });
  </script>
</body>
</html>
