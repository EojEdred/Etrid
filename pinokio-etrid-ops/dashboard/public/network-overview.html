<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Network Overview - Etrid Operations Center</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    .network-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .network-stat {
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .network-stat:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }

    .network-stat .icon {
      font-size: 2.5rem;
      margin-bottom: 12px;
    }

    .network-stat .value {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 12px 0;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .network-stat .label {
      color: var(--text-secondary);
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .map-container {
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      margin: 30px 0;
      min-height: 500px;
      position: relative;
      overflow: hidden;
    }

    .map-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 500px;
      background: linear-gradient(135deg, rgba(77, 163, 255, 0.05), rgba(0, 214, 143, 0.05));
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 1.2rem;
    }

    .validators-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .validators-table th,
    .validators-table td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .validators-table th {
      background: var(--background-color);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
    }

    .validators-table tr:hover {
      background: rgba(77, 163, 255, 0.05);
      cursor: pointer;
    }

    .validator-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .location-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      background: rgba(77, 163, 255, 0.1);
      color: var(--accent-blue);
      font-size: 0.85rem;
    }

    .version-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      background: rgba(0, 214, 143, 0.1);
      color: var(--accent-green);
      font-size: 0.85rem;
      font-family: 'Courier New', monospace;
    }

    .issues-section {
      margin: 30px 0;
    }

    .issue-card {
      background: var(--surface-color);
      border-left: 4px solid var(--accent-yellow);
      border-radius: 8px;
      padding: 20px;
      margin: 12px 0;
    }

    .issue-card.high {
      border-left-color: var(--accent-red);
    }

    .issue-card.medium {
      border-left-color: var(--accent-yellow);
    }

    .issue-card.low {
      border-left-color: var(--accent-blue);
    }

    .issue-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .severity-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .severity-badge.high {
      background: rgba(255, 82, 82, 0.15);
      color: var(--accent-red);
    }

    .severity-badge.medium {
      background: rgba(255, 184, 0, 0.15);
      color: var(--accent-yellow);
    }

    .severity-badge.low {
      background: rgba(77, 163, 255, 0.15);
      color: var(--accent-blue);
    }

    .refresh-button {
      padding: 10px 20px;
      background: var(--accent-blue);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: opacity 0.2s;
    }

    .refresh-button:hover {
      opacity: 0.9;
    }

    .refresh-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .filter-controls {
      display: flex;
      gap: 12px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .filter-button {
      padding: 8px 16px;
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .filter-button:hover {
      background: rgba(77, 163, 255, 0.1);
      border-color: var(--accent-blue);
    }

    .filter-button.active {
      background: var(--accent-blue);
      color: white;
      border-color: var(--accent-blue);
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div>
        <h1 style="display: flex; align-items: center; gap: 16px;">
          üåê Network Overview
          <span id="network-status-badge" class="status-badge">Loading...</span>
        </h1>
        <p class="subtitle">Real-time monitoring of all Etrid validators</p>
      </div>
      <div style="display: flex; gap: 12px; align-items: center;">
        <button class="refresh-button" id="refresh-btn" onclick="refreshNetworkData()">
          <span id="refresh-text">üîÑ Refresh</span>
        </button>
        <button class="btn btn-secondary" onclick="window.location.href='/dashboard.html'">
          ‚Üê Back to Dashboard
        </button>
        <button class="btn btn-secondary" onclick="handleLogout()">Logout</button>
      </div>
    </div>

    <!-- Network Statistics Grid -->
    <div class="network-grid">
      <div class="network-stat">
        <div class="icon">üîó</div>
        <div class="value" id="total-validators">-</div>
        <div class="label">Total Validators</div>
      </div>
      <div class="network-stat">
        <div class="icon">üü¢</div>
        <div class="value" id="online-validators">-</div>
        <div class="label">Online Validators</div>
      </div>
      <div class="network-stat">
        <div class="icon">üìä</div>
        <div class="value" id="network-block-height">-</div>
        <div class="label">Network Block Height</div>
      </div>
      <div class="network-stat">
        <div class="icon">üåç</div>
        <div class="value" id="total-peers">-</div>
        <div class="label">Total Network Peers</div>
      </div>
      <div class="network-stat">
        <div class="icon">‚ö°</div>
        <div class="value" id="avg-finality">-</div>
        <div class="label">Avg Finality Time</div>
      </div>
      <div class="network-stat">
        <div class="icon">‚è±Ô∏è</div>
        <div class="value" id="avg-block-time">-</div>
        <div class="label">Avg Block Time</div>
      </div>
    </div>

    <!-- Network Issues Alert -->
    <div class="issues-section" id="issues-section" style="display: none;">
      <h3 style="display: flex; align-items: center; gap: 12px;">
        ‚ö†Ô∏è Network Issues Detected
      </h3>
      <div id="issues-container"></div>
    </div>

    <!-- Healthy Network Message -->
    <div class="card" id="healthy-message" style="display: none; text-align: center; padding: 30px; background: linear-gradient(135deg, rgba(0, 214, 143, 0.1), rgba(0, 214, 143, 0.05));">
      <div style="font-size: 3rem; margin-bottom: 12px;">‚úì</div>
      <h3 style="color: var(--accent-green); margin-bottom: 8px;">Network Healthy</h3>
      <p style="color: var(--text-secondary);">All validators are operating normally with no detected issues.</p>
    </div>

    <!-- Geographic Map -->
    <div class="card">
      <h3 style="display: flex; align-items: center; justify-content: space-between;">
        <span>üó∫Ô∏è Validator Geographic Distribution</span>
        <span style="font-size: 0.85rem; font-weight: normal; color: var(--text-secondary);" id="map-updated">-</span>
      </h3>
      <div class="map-container">
        <div class="map-placeholder">
          <div style="text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 16px;">üåç</div>
            <div>Geographic map visualization</div>
            <div style="font-size: 0.85rem; margin-top: 8px; color: var(--text-secondary);">
              Showing validator distribution across datacenters
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Validators Table -->
    <div class="card">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
        <h3>üìã All Validators</h3>
        <div class="filter-controls">
          <button class="filter-button active" data-filter="all" onclick="filterValidators('all')">
            All
          </button>
          <button class="filter-button" data-filter="online" onclick="filterValidators('online')">
            Online Only
          </button>
          <button class="filter-button" data-filter="offline" onclick="filterValidators('offline')">
            Issues
          </button>
          <button class="filter-button" data-filter="syncing" onclick="filterValidators('syncing')">
            Syncing
          </button>
        </div>
      </div>
      <div style="overflow-x: auto;">
        <table class="validators-table">
          <thead>
            <tr>
              <th>Status</th>
              <th>Validator Name</th>
              <th>Location</th>
              <th>Block Height</th>
              <th>Peers</th>
              <th>Version</th>
              <th>Chain</th>
              <th>Last Updated</th>
            </tr>
          </thead>
          <tbody id="validators-table-body">
            <tr>
              <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                Loading validators...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
      <h3>‚ö° Quick Actions</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 20px;">
        <button class="btn btn-primary" onclick="window.location.href='/finality-dashboard.html'">
          üìä Finality Dashboard
        </button>
        <button class="btn btn-secondary" onclick="exportNetworkData()">
          üíæ Export Network Data
        </button>
        <button class="btn btn-secondary" onclick="viewNetworkLogs()">
          üìú Network Logs
        </button>
        <button class="btn btn-secondary" onclick="window.location.href='/dashboard.html'">
          ‚öôÔ∏è Manage Nodes
        </button>
      </div>
    </div>
  </div>

  <script src="/auth.js"></script>
  <script>
    let allValidators = [];
    let currentFilter = 'all';
    let refreshInterval = null;

    async function loadNetworkData() {
      try {
        // Fetch network overview
        const response = await authenticatedFetch('/api/network/overview');
        const data = await response.json();

        allValidators = data.validators;

        // Update network statistics
        updateNetworkStats(data.stats, data.finality);

        // Update validators table
        updateValidatorsTable(data.validators);

        // Check for network issues
        await checkNetworkIssues();

        // Update network status badge
        const badge = document.getElementById('network-status-badge');
        const onlineCount = data.validators.filter(v => v.status === 'online').length;
        const totalCount = data.validators.length;

        if (onlineCount === totalCount) {
          badge.textContent = '‚úì All Systems Operational';
          badge.className = 'status-badge online';
        } else if (onlineCount >= totalCount * 0.8) {
          badge.textContent = '‚ö† Some Issues Detected';
          badge.className = 'status-badge';
        } else {
          badge.textContent = 'üî¥ Critical Issues';
          badge.className = 'status-badge offline';
        }

        // Update last updated time
        document.getElementById('map-updated').textContent = `Updated ${new Date().toLocaleTimeString()}`;

      } catch (err) {
        console.error('Failed to load network data:', err);
        showError('Failed to load network data: ' + err.message);
      }
    }

    function updateNetworkStats(stats, finality) {
      document.getElementById('total-validators').textContent = stats.totalValidators || '-';
      document.getElementById('online-validators').textContent = stats.onlineValidators || '-';
      document.getElementById('network-block-height').textContent = (stats.averageBlockHeight || 0).toLocaleString();
      document.getElementById('total-peers').textContent = stats.totalPeers || '-';

      if (finality) {
        document.getElementById('avg-finality').textContent = `${finality.finalityTime.toFixed(1)}s`;
        document.getElementById('avg-block-time').textContent = `${finality.blockTime.toFixed(1)}s`;
      } else {
        document.getElementById('avg-finality').textContent = '-';
        document.getElementById('avg-block-time').textContent = '-';
      }
    }

    function updateValidatorsTable(validators) {
      const tbody = document.getElementById('validators-table-body');

      if (validators.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-secondary);">
              No validators found
            </td>
          </tr>
        `;
        return;
      }

      // Filter validators based on current filter
      let filteredValidators = validators;
      if (currentFilter === 'online') {
        filteredValidators = validators.filter(v => v.status === 'online');
      } else if (currentFilter === 'offline') {
        filteredValidators = validators.filter(v => v.status === 'offline' || v.status === 'error');
      } else if (currentFilter === 'syncing') {
        filteredValidators = validators.filter(v => v.isSyncing);
      }

      tbody.innerHTML = filteredValidators.map(v => {
        const statusIcon = v.status === 'online' ? 'üü¢' : 'üî¥';
        const syncBadge = v.isSyncing ? '<span style="color: var(--accent-yellow); margin-left: 8px;">‚Üª Syncing</span>' : '';
        const location = v.location || 'Unknown';
        const blockHeight = v.blockHeight > 0 ? v.blockHeight.toLocaleString() : '-';
        const peers = v.peers || '-';
        const version = v.version || 'Unknown';
        const lastUpdated = v.lastUpdated ? new Date(v.lastUpdated).toLocaleTimeString() : '-';

        return `
          <tr onclick="viewValidatorDetails('${v.nodeName}')">
            <td>${statusIcon} ${syncBadge}</td>
            <td class="validator-name">${v.nodeName}</td>
            <td><span class="location-badge">${location}</span></td>
            <td>${blockHeight}</td>
            <td>${peers}</td>
            <td><span class="version-badge">${version}</span></td>
            <td>${v.chain}</td>
            <td style="color: var(--text-secondary); font-size: 0.9rem;">${lastUpdated}</td>
          </tr>
        `;
      }).join('');
    }

    async function checkNetworkIssues() {
      try {
        const response = await authenticatedFetch('/api/network/issues');
        const data = await response.json();

        const issuesSection = document.getElementById('issues-section');
        const healthyMessage = document.getElementById('healthy-message');
        const issuesContainer = document.getElementById('issues-container');

        if (data.issues && data.issues.length > 0) {
          issuesSection.style.display = 'block';
          healthyMessage.style.display = 'none';

          issuesContainer.innerHTML = data.issues.map(issue => {
            const severityClass = issue.severity || 'medium';
            return `
              <div class="issue-card ${severityClass}">
                <div class="issue-header">
                  <span class="severity-badge ${severityClass}">${severityClass}</span>
                  <span style="font-weight: 600;">${issue.type.replace(/_/g, ' ').toUpperCase()}</span>
                </div>
                <p style="margin: 8px 0; color: var(--text-secondary);">${issue.message}</p>
                ${issue.affectedValidators ? `
                  <div style="margin-top: 12px; font-size: 0.9rem;">
                    <strong>Affected Validators:</strong> ${issue.affectedValidators.join(', ')}
                  </div>
                ` : ''}
              </div>
            `;
          }).join('');
        } else {
          issuesSection.style.display = 'none';
          healthyMessage.style.display = 'block';
        }
      } catch (err) {
        console.error('Failed to check network issues:', err);
      }
    }

    function filterValidators(filter) {
      currentFilter = filter;

      // Update active button
      document.querySelectorAll('.filter-button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === filter) {
          btn.classList.add('active');
        }
      });

      // Update table
      updateValidatorsTable(allValidators);
    }

    async function refreshNetworkData() {
      const btn = document.getElementById('refresh-btn');
      const text = document.getElementById('refresh-text');

      btn.disabled = true;
      text.innerHTML = '<span class="loading-spinner"></span> Refreshing...';

      await loadNetworkData();

      setTimeout(() => {
        btn.disabled = false;
        text.textContent = 'üîÑ Refresh';
      }, 1000);
    }

    function viewValidatorDetails(nodeName) {
      // Navigate to validator detail page (could be validator.html with query param)
      window.location.href = `/validator.html?node=${encodeURIComponent(nodeName)}`;
    }

    function exportNetworkData() {
      const dataStr = JSON.stringify(allValidators, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `etrid-network-${Date.now()}.json`;
      link.click();
      URL.revokeObjectURL(url);
      showToast('Network data exported!', 'success');
    }

    function viewNetworkLogs() {
      showToast('Network logs feature coming soon!', 'info');
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function showError(message) {
      const badge = document.getElementById('network-status-badge');
      badge.textContent = '‚ùå Error';
      badge.className = 'status-badge offline';
      showToast(message, 'error');
    }

    function handleLogout() {
      logout();
      window.location.href = '/login.html';
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', async () => {
      await loadUserInfo();
      await loadNetworkData();

      // Auto-refresh every 30 seconds
      refreshInterval = setInterval(loadNetworkData, 30000);
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (refreshInterval) {
        clearInterval(refreshInterval);
      }
    });
  </script>
</body>
</html>
